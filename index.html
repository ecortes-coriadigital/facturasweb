<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facturación Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Estilos personalizados */
        .table-input { width: 100%; padding: 4px; border: 1px solid transparent; border-radius: 4px; background: transparent; font-variant-numeric: tabular-nums; transition: all 0.2s; font-size: 0.75rem; }
        .table-input:hover { border-color: #cbd5e1; background: #f8fafc; }
        .table-input:focus { border-color: #6366f1; background: #ffffff; outline: none; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        .table-locked { background-color: #f1f5f9; color: #64748b; border: none; cursor: not-allowed; text-align: center; border-radius: 4px; padding: 4px; width: 100%; font-size: 0.7rem; user-select: none; }
        
        /* Estilos para celdas seleccionables */
        .table-select { cursor: pointer; border-radius: 4px; padding: 4px; width: 100%; text-align: center; border: 1px solid transparent; transition: all 0.2s; position: relative; }
        .table-select:hover { background-color: #e0e7ff; border-color: #6366f1; }
        
        /* Tooltip personalizado */
        .tooltip-text { visibility: hidden; width: 120px; background-color: #1e293b; color: #fff; text-align: center; border-radius: 6px; padding: 5px; position: absolute; z-index: 50; bottom: 125%; left: 50%; margin-left: -60px; opacity: 0; transition: opacity 0.3s; font-size: 0.65rem; pointer-events: none; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .table-select:hover .tooltip-text { visibility: visible; opacity: 1; }
        .tooltip-text::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #1e293b transparent transparent transparent; }

        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3498db; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay" class="absolute inset-0 bg-slate-900/95 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md border border-slate-700 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 to-purple-500"></div>
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-indigo-700 mb-2 tracking-tight">Facturación Pro</h1>
                <p class="text-slate-500 text-sm">Sistema de Facturación Inteligente</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-600 mb-1 uppercase">Correo Electrónico</label>
                    <input type="email" id="email" class="w-full border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition" placeholder="usuario@excel.com.mx">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-600 mb-1 uppercase">Contraseña</label>
                    <input type="password" id="password" class="w-full border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition" placeholder="••••••••">
                </div>
                <button onclick="handleLogin()" id="btn-login" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition shadow-lg flex justify-center items-center gap-2 transform active:scale-95">
                    <i class="fas fa-sign-in-alt"></i> Ingresar / Registrarse
                </button>
                <div id="login-msg" class="text-center text-sm text-red-500 hidden mt-2 bg-red-50 p-2 rounded border border-red-100"></div>
            </div>
            <p class="text-[10px] text-center text-slate-400 mt-6">
                <i class="fas fa-lock mr-1"></i> Conexión Segura con Supabase
            </p>
        </div>
    </div>

    <!-- ERROR MODAL (Nuevo) -->
    <div id="error-modal" class="absolute inset-0 bg-slate-900/50 z-50 hidden flex items-center justify-center backdrop-blur-sm fade-in">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm border border-red-200 overflow-hidden transform transition-all scale-100">
            <div class="bg-red-600 p-3 flex justify-between items-center text-white">
                <h3 class="font-bold text-sm flex items-center gap-2"><i class="fas fa-exclamation-triangle"></i> Datos Faltantes</h3>
                <button onclick="closeError()" class="hover:bg-red-700 p-1 rounded transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 bg-slate-50 text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto text-red-500 text-3xl mb-4">
                    <i class="fas fa-search-minus"></i>
                </div>
                <p id="error-text" class="text-sm text-slate-700 font-medium mb-6 whitespace-pre-line leading-relaxed"></p>
                <button onclick="closeError()" class="bg-slate-800 hover:bg-slate-900 text-white font-bold py-2 px-6 rounded-lg text-xs transition">Entendido, revisar archivo</button>
            </div>
        </div>
    </div>

    <!-- SELECTOR MODAL -->
    <div id="selector-modal" class="absolute inset-0 bg-slate-900/50 z-40 hidden flex items-center justify-center backdrop-blur-sm fade-in">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm border border-slate-200 overflow-hidden transform transition-all scale-100">
            <div class="bg-indigo-600 p-3 flex justify-between items-center text-white">
                <h3 class="font-bold text-sm flex items-center gap-2"><i class="fas fa-list-ul"></i> Seleccionar Opción</h3>
                <button onclick="closeSelector()" class="hover:bg-indigo-700 p-1 rounded transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 bg-slate-50">
                <div id="selector-list" class="space-y-2">
                    <!-- Opciones inyectadas por JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- HEADER SUPERIOR -->
    <header class="bg-white border-b border-slate-200 p-4 shadow-sm shrink-0 z-20 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold text-indigo-700 flex items-center gap-2">
                <i class="fas fa-cloud text-indigo-500"></i> Facturación Pro
            </h1>
            <div class="flex items-center gap-2 mt-1">
                <span id="user-email" class="text-xs text-slate-500 font-mono">Cargando...</span>
                <span class="bg-green-100 text-green-700 text-[10px] px-2 py-0.5 rounded-full border border-green-200 font-bold flex items-center gap-1">
                    <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Online
                </span>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleDatabasePanel()" class="bg-slate-800 hover:bg-slate-700 text-white text-xs font-medium px-4 py-2 rounded shadow transition flex items-center gap-2">
                <i class="fas fa-database"></i> Conceptos
                <span id="concept-count" class="bg-slate-600 text-[10px] px-1.5 rounded-full">0</span>
            </button>
            <button onclick="handleLogout()" class="bg-red-50 hover:bg-red-100 text-red-600 text-xs px-3 py-2 rounded transition border border-red-100" title="Cerrar Sesión">
                <i class="fas fa-power-off"></i>
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- PANEL LATERAL -->
        <div id="db-panel" class="absolute inset-y-0 right-0 w-full md:w-[450px] bg-white shadow-2xl border-l border-slate-200 transform translate-x-full transition-transform duration-300 z-30 flex flex-col">
            <div class="p-4 bg-slate-100 border-b border-slate-200 flex justify-between items-center">
                <h2 class="font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-server text-indigo-500"></i> Catálogo Cloud</h2>
                <button onclick="toggleDatabasePanel()" class="text-slate-400 hover:text-red-500 transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="bg-yellow-50 p-3 border-b border-yellow-100 flex justify-between items-center text-yellow-800">
                <div class="text-[10px]">
                    <p class="font-bold"><i class="fas fa-history"></i> Memoria de Rotación</p>
                    <p>El sistema recuerda el último concepto usado.</p>
                </div>
                <button onclick="resetCloudCounters()" class="bg-white border border-yellow-300 hover:bg-yellow-100 text-[10px] font-bold px-2 py-1 rounded shadow-sm transition active:scale-95">
                    <i class="fas fa-sync-alt mr-1"></i> Resetear
                </button>
            </div>

            <div class="p-4 bg-indigo-50 border-b border-indigo-100 shrink-0 space-y-3">
                <h3 class="text-xs font-bold text-indigo-800 uppercase flex items-center gap-1"><i class="fas fa-plus-circle"></i> Nuevo Concepto</h3>
                <div class="space-y-2">
                    <div class="relative">
                         <i class="fas fa-user absolute left-3 top-2.5 text-slate-400 text-xs"></i>
                        <input type="text" id="new-rfc" placeholder="RFC Cliente (Receptor)" class="w-full text-xs border border-indigo-200 rounded p-2 pl-8 uppercase font-bold focus:ring-1 focus:ring-indigo-500 outline-none">
                    </div>
                    <input type="text" id="new-concepto" placeholder="Descripción del Concepto" class="w-full text-xs border border-indigo-200 rounded p-2 focus:ring-1 focus:ring-indigo-500 outline-none">
                    <div class="flex gap-2">
                        <input type="text" id="new-clave" placeholder="Clave SAT (Ej. 80101600)" class="w-2/3 text-xs border border-indigo-200 rounded p-2 focus:ring-1 focus:ring-indigo-500 outline-none">
                        <input type="text" id="new-unidad" placeholder="Unidad (Ej. E48)" class="w-1/3 text-xs border border-indigo-200 rounded p-2 focus:ring-1 focus:ring-indigo-500 outline-none">
                    </div>
                    <button onclick="addConceptCloud()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold py-2 rounded shadow transition flex justify-center gap-2">
                        <i class="fas fa-save"></i> Guardar en Nube
                    </button>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4" id="db-list">
                <div class="text-center mt-10">
                    <div class="loader mx-auto mb-2"></div>
                    <p class="text-xs text-slate-400">Sincronizando con Supabase...</p>
                </div>
            </div>
        </div>

        <!-- ESPACIO DE TRABAJO PRINCIPAL -->
        <main class="flex-1 flex flex-col bg-slate-50 p-4 md:p-6 overflow-hidden">
            
            <!-- ZONA DE CARGA (Upload) -->
            <div id="upload-card" class="bg-white rounded-xl shadow-lg border border-slate-200 p-10 flex flex-col items-center justify-center h-full fade-in">
                <div class="w-full max-w-lg text-center">
                    <div id="drop-zone" class="border-4 border-dashed border-indigo-100 rounded-3xl p-12 hover:bg-indigo-50/50 hover:border-indigo-300 transition-all cursor-pointer relative group">
                        <input type="file" id="file-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" accept=".xlsx, .xls, .csv">
                        <div class="transform group-hover:scale-105 transition-transform duration-300">
                            <div class="w-24 h-24 bg-indigo-100 rounded-full flex items-center justify-center mx-auto text-indigo-500 text-4xl mb-6 shadow-inner">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-slate-700 mb-2">Sube tu Archivo Base</h3>
                            <p class="text-sm text-slate-500 px-4">El sistema detectará a tus clientes y aplicará la rotación de conceptos automáticamente.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EDITOR DE TABLA -->
            <div id="editor-area" class="hidden flex-1 flex flex-col bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden slide-in">
                
                <div class="p-3 bg-slate-50 border-b border-slate-200 flex justify-between items-center shrink-0">
                    <div class="flex items-center gap-3">
                        <button onclick="resetApp()" class="text-xs font-bold text-slate-500 hover:text-indigo-600 flex items-center gap-1 border-r border-slate-300 pr-3 transition">
                            <i class="fas fa-arrow-left"></i> Subir Otro
                        </button>
                        <span class="text-xs font-mono bg-white border px-2 py-1 rounded shadow-sm">
                            <i class="fas fa-list mr-1 text-slate-400"></i> <span id="row-count">0</span> regs
                        </span>
                        <div id="process-status" class="hidden text-xs text-green-600 font-bold items-center gap-1">
                            <i class="fas fa-check-circle"></i> Procesado
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <button id="download-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1.5 px-4 rounded shadow-md text-sm flex items-center gap-2 transition transform hover:-translate-y-0.5">
                            <i class="fas fa-file-excel"></i> Descargar .XLS
                        </button>
                    </div>
                </div>

                <div class="flex-1 overflow-auto bg-slate-100">
                    <table class="min-w-full divide-y divide-slate-200 border-separate border-spacing-0">
                        <thead class="bg-slate-50 sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="px-3 py-3 text-left text-[10px] font-bold text-slate-400 uppercase tracking-wider border-b w-10">#</th>
                                <th class="px-3 py-3 text-left text-xs font-bold text-indigo-700 uppercase tracking-wider border-b w-40 bg-indigo-50/30">Cliente</th>
                                <th class="px-3 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider border-b w-64">Concepto (Auto)</th>
                                <th class="px-3 py-3 text-left text-xs font-bold text-pink-600 uppercase tracking-wider border-b bg-pink-50/30 w-28">Clave SAT</th>
                                <th class="px-2 py-3 text-center text-xs font-bold text-slate-400 uppercase tracking-wider border-b w-16 bg-slate-50">Unidad <i class="fas fa-lock text-[9px]"></i></th>
                                <th class="px-2 py-3 text-center text-xs font-bold text-slate-400 uppercase tracking-wider border-b w-16 bg-slate-50">Uso <i class="fas fa-lock text-[9px]"></i></th>
                                <th class="px-2 py-3 text-center text-xs font-bold text-slate-500 uppercase tracking-wider border-b w-20">Forma <i class="fas fa-hand-pointer text-[9px] text-indigo-400"></i></th>
                                <th class="px-2 py-3 text-center text-xs font-bold text-slate-500 uppercase tracking-wider border-b w-20">Metodo <i class="fas fa-hand-pointer text-[9px] text-indigo-400"></i></th>
                                <th class="px-3 py-3 text-right text-xs font-bold text-slate-500 uppercase tracking-wider border-b w-24">Subtotal</th>
                                <th class="px-3 py-3 text-right text-xs font-bold text-slate-500 uppercase tracking-wider border-b w-20">IVA</th>
                                <th class="px-3 py-3 text-right text-xs font-bold text-slate-800 uppercase tracking-wider border-b w-24 bg-slate-50">Total</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="bg-white divide-y divide-slate-200"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- LÓGICA DE JAVASCRIPT -->
    <script>
        // ... (Supabase config se mantiene igual) ...
        const SUPABASE_URL = 'https://pterywrqklbkrurwplad.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_lHp-PoCLTFLFdXpkwja4cQ_9lQeUMxb';
        
        let supabaseClient;
        try {
            if (window.supabase) supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch (e) { console.error(e); }

        let session = null;
        let cloudConcepts = []; 
        let globalData = [];    
        let rawDataCache = null;

        // ==========================================
        // CONFIGURACIÓN DE CATÁLOGOS SAT
        // ==========================================
        const CATALOGOS = {
            FORMA: {
                '03': 'Transferencia electrónica',
                '99': 'Por definir'
            },
            METODO: {
                'PUE': 'Pago en una exhibición',
                'PPD': 'Pago en parcialidades'
            }
        };

        // ... (Funciones init, auth se mantienen igual) ...
        async function init() {
            if (!supabaseClient) return;
            const { data } = await supabaseClient.auth.getSession();
            session = data.session;
            updateAuthUI();
            supabaseClient.auth.onAuthStateChange((_event, _session) => {
                session = _session;
                updateAuthUI();
            });
        }
        function updateAuthUI() {
            if (session) {
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('user-email').textContent = session.user.email;
                loadCloudConcepts(); 
            } else {
                document.getElementById('login-overlay').classList.remove('hidden');
            }
        }
        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('btn-login');
            const msg = document.getElementById('login-msg');
            if(!email || !password) return;
            btn.innerHTML = '<div class="loader"></div>';
            msg.classList.add('hidden');
            let { error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) {
                if (error.message.includes("Invalid login")) {
                     let resUp = await supabaseClient.auth.signUp({ email, password });
                     if (resUp.error) { msg.textContent = resUp.error.message; msg.classList.remove('hidden'); }
                     else { alert("Cuenta creada. Revisa tu correo o intenta ingresar."); }
                } else { msg.textContent = error.message; msg.classList.remove('hidden'); }
            }
            btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Ingresar / Registrarse';
        }
        async function handleLogout() {
            await supabaseClient.auth.signOut();
            location.reload();
        }

        // ... (Gestión de Catálogo Cloud igual) ...
        async function loadCloudConcepts() {
            if (!session) return;
            const { data, error } = await supabaseClient.from('conceptos').select('*').order('created_at', { ascending: false });
            if (!error) {
                cloudConcepts = data || [];
                renderCloudList();
                document.getElementById('concept-count').textContent = cloudConcepts.length;
            }
        }
        async function addConceptCloud() {
            const rfc = document.getElementById('new-rfc').value.trim().toUpperCase();
            const concepto = document.getElementById('new-concepto').value.trim();
            const clave = document.getElementById('new-clave').value.trim();
            const unidad = document.getElementById('new-unidad').value.trim().toUpperCase() || 'E48';
            if (!rfc || !concepto) return alert("RFC y Concepto requeridos");
            const { data, error } = await supabaseClient.from('conceptos').insert([
                { user_id: session.user.id, rfc_cliente: rfc, concepto, clave_sat: clave, unidad }
            ]).select();
            if (error) alert("Error guardando: " + error.message);
            else {
                cloudConcepts.unshift(data[0]);
                renderCloudList();
                document.getElementById('new-concepto').value = '';
                document.getElementById('new-clave').value = '';
            }
        }
        async function deleteConceptCloud(id) {
            if(!confirm("¿Eliminar este concepto del catálogo?")) return;
            const { error } = await supabaseClient.from('conceptos').delete().eq('id', id);
            if (!error) {
                cloudConcepts = cloudConcepts.filter(c => c.id !== id);
                renderCloudList();
            }
        }
        function renderCloudList() {
            const list = document.getElementById('db-list');
            list.innerHTML = '';
            const grouped = {};
            cloudConcepts.forEach(c => {
                if(!grouped[c.rfc_cliente]) grouped[c.rfc_cliente] = [];
                grouped[c.rfc_cliente].push(c);
            });
            if (Object.keys(grouped).length === 0) {
                list.innerHTML = '<div class="text-center mt-10 text-slate-400 text-xs"><i class="fas fa-box-open text-2xl mb-2"></i><br>Catálogo vacío</div>';
                return;
            }
            Object.keys(grouped).forEach(rfc => {
                const groupDiv = document.createElement('div');
                groupDiv.className = "mb-3 border border-slate-200 rounded-lg overflow-hidden";
                groupDiv.innerHTML = `
                    <div class="bg-slate-50 px-3 py-2 text-xs font-bold text-slate-600 border-b flex justify-between items-center">
                        <span><i class="fas fa-user-tag mr-1 text-indigo-400"></i> ${rfc}</span>
                        <span class="bg-white px-2 rounded-full border text-[10px] shadow-sm">${grouped[rfc].length}</span>
                    </div>`;
                grouped[rfc].forEach(item => {
                    const row = document.createElement('div');
                    row.className = "p-2 bg-white border-b last:border-0 flex justify-between items-center hover:bg-slate-50 group";
                    row.innerHTML = `
                        <div class="flex-1 overflow-hidden">
                            <p class="text-xs font-medium truncate text-slate-700">${item.concepto}</p>
                            <div class="flex gap-2 text-[10px] text-slate-400 mt-0.5">
                                <span class="bg-pink-50 text-pink-600 px-1 rounded">${item.clave_sat}</span>
                                <span>${item.unidad}</span>
                            </div>
                        </div>
                        <button onclick="deleteConceptCloud(${item.id})" class="text-slate-300 hover:text-red-500 transition px-2 opacity-0 group-hover:opacity-100"><i class="fas fa-trash"></i></button>`;
                    groupDiv.appendChild(row);
                });
                list.appendChild(groupDiv);
            });
            document.getElementById('concept-count').textContent = cloudConcepts.length;
        }
        async function resetCloudCounters() {
            if(!confirm("⚠️ ¿Resetear contadores?")) return;
            const { error } = await supabaseClient.from('historial_rotacion').delete().neq('id', 0); 
            if(!error) alert("✅ Contadores reiniciados.");
            else alert("Error: " + error.message);
        }

        // ==========================================
        // MANEJO DE ERRORES (Nuevo)
        // ==========================================
        function showError(msg) {
            document.getElementById('error-text').textContent = msg;
            document.getElementById('error-modal').classList.remove('hidden');
        }
        function closeError() {
            document.getElementById('error-modal').classList.add('hidden');
        }

        // ==========================================
        // LÓGICA DE PROCESAMIENTO
        // ==========================================
        document.getElementById('file-input').addEventListener('change', async function(evt) {
            const file = evt.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                rawDataCache = XLSX.utils.sheet_to_json(firstSheet, {defval:""});
                // Ocultar card de carga temporalmente, se mostrará editor si todo ok
                document.getElementById('upload-card').classList.add('hidden');
                
                await processExcelData(rawDataCache);
            };
            reader.readAsArrayBuffer(file);
        });

        async function processExcelData(data) {
            if(data.length === 0) return;
            const headers = Object.keys(data[0]);
            const find = (k) => headers.find(h => String(h).toUpperCase().replace(/\s/g, '').includes(k.toUpperCase()));
            const map = {
                rfcRx: find('RFCCLIENTE') || find('RECEPTOR'),
                rfcEm: find('RFCEMISOR') || find('RFCFACTURADORA') || find('EMISOR'),
                con: find('CONCEPTO'),
                sub: find('SUBTOTAL') || find('IMPORTE'),
                iva: find('IVA') || find('IMPUESTO'),
                tot: find('TOTAL'),
                uso: find('USOCFDI') || find('USO'),
                forma: find('FORMAPAGO') || find('FORMA'),
                met: find('METODOPAGO') || find('METODO'),
                cant: find('CANTIDAD')
            };

            // VALIDACIÓN DE COLUMNAS (Obligatorias)
            const missingCols = [];
            if (!map.rfcRx) missingCols.push("RFC Receptor / Cliente");
            if (!map.sub && !map.tot) missingCols.push("Subtotal o Total");

            if (missingCols.length > 0) {
                showError(`No se encontraron las siguientes columnas obligatorias en tu archivo:\n\n• ${missingCols.join('\n• ')}\n\nPor favor verifica los encabezados de tu Excel.`);
                // Regresar al estado inicial
                document.getElementById('upload-card').classList.remove('hidden');
                return; // DETENER PROCESO
            }

            // Continuar si todo ok
            document.getElementById('editor-area').classList.remove('hidden');

            const { data: history } = await supabaseClient.from('historial_rotacion').select('*');
            let localCounters = {};
            history?.forEach(h => localCounters[h.rfc_cliente] = h.ultimo_indice);

            globalData = [];

            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                const rfc = String(row[map.rfcRx] || "").toUpperCase().replace(/[^A-Z0-9&]/g, '').trim();
                
                // VALIDACIÓN DE FILA: Si no hay RFC, ignorar fila vacía
                if (!rfc) continue;

                const rfcEmisor = String(row[map.rfcEm] || "").trim().toUpperCase();
                
                let concepto = row[map.con] || "Servicios Profesionales";
                let clave = "80101600";
                let unidad = "E48";
                
                const opciones = cloudConcepts.filter(c => c.rfc_cliente === rfc);
                if (opciones.length > 0) {
                    if (localCounters[rfc] === undefined) localCounters[rfc] = 0;
                    const index = localCounters[rfc] % opciones.length;
                    const selected = opciones[index];
                    concepto = selected.concepto;
                    clave = selected.clave_sat;
                    unidad = selected.unidad;
                    localCounters[rfc]++;
                }

                const sub = parseFloat(row[map.sub]) || 0;
                const iva = parseFloat(row[map.iva]) || 0;
                const tot = (sub > 0 || iva > 0) ? (sub + iva) : (parseFloat(row[map.tot]) || 0);

                // Normalización de Forma y Método
                let forma = String(row[map.forma]||"99").padStart(2,'0');
                if(!CATALOGOS.FORMA[forma]) forma = "99"; 

                let metodo = (row[map.met]||"PPD").toUpperCase().trim();
                if(!CATALOGOS.METODO[metodo] && metodo !== "PUE" && metodo !== "PPD") metodo = "PPD"; 

                globalData.push({
                    RFC: rfc,
                    RFC_EMISOR: rfcEmisor,
                    CONCEPTO: concepto,
                    CLAVE: clave,
                    UNIDAD: unidad,
                    USO: String(row[map.uso]||"G03").split(' ')[0],
                    FORMA: forma,
                    METODO: metodo,
                    SUBTOTAL: sub,
                    IVA: iva,
                    TOTAL: tot
                });
            }

            if (globalData.length === 0) {
                 showError("El archivo no contiene registros válidos (con RFC).");
                 document.getElementById('editor-area').classList.add('hidden');
                 document.getElementById('upload-card').classList.remove('hidden');
                 return;
            }

            updateCloudCounters(localCounters);
            renderTable();
        }

        async function updateCloudCounters(counters) {
            document.getElementById('process-status').classList.remove('hidden');
            document.getElementById('process-status').innerHTML = '<i class="fas fa-sync fa-spin"></i> Guardando...';
            for (const [rfc, idx] of Object.entries(counters)) {
                await supabaseClient.from('historial_rotacion').upsert(
                    { user_id: session.user.id, rfc_cliente: rfc, ultimo_indice: idx },
                    { onConflict: 'user_id, rfc_cliente' }
                );
            }
            document.getElementById('process-status').innerHTML = '<i class="fas fa-check-circle"></i> Actualizado';
            setTimeout(() => document.getElementById('process-status').classList.add('hidden'), 3000);
        }

        // ==========================================
        // GESTIÓN DEL SELECTOR MODAL
        // ==========================================
        let currentSelectorRow = -1;
        let currentSelectorType = null;

        window.openSelector = function(rowIdx, type) {
            currentSelectorRow = rowIdx;
            currentSelectorType = type;
            const list = document.getElementById('selector-list');
            list.innerHTML = '';

            const options = type === 'FORMA' ? CATALOGOS.FORMA : CATALOGOS.METODO;
            
            Object.entries(options).forEach(([code, desc]) => {
                const div = document.createElement('div');
                div.className = "p-3 rounded border border-slate-200 hover:bg-indigo-50 hover:border-indigo-300 cursor-pointer flex items-center justify-between transition group";
                div.onclick = () => selectOption(code);
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-indigo-600 bg-indigo-50 border border-indigo-100 px-2 py-1 rounded text-xs">${code}</span>
                        <span class="text-sm text-slate-700 font-medium">${desc}</span>
                    </div>
                    <i class="fas fa-check text-indigo-500 opacity-0 group-hover:opacity-100"></i>
                `;
                list.appendChild(div);
            });

            document.getElementById('selector-modal').classList.remove('hidden');
        };

        window.closeSelector = function() {
            document.getElementById('selector-modal').classList.add('hidden');
        };

        window.selectOption = function(value) {
            if (currentSelectorRow > -1 && currentSelectorType) {
                globalData[currentSelectorRow][currentSelectorType] = value;
                renderTable(); // Re-render para actualizar UI y Tooltips
                closeSelector();
            }
        };

        // ==========================================
        // RENDERIZADO DE TABLA
        // ==========================================
        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            document.getElementById('row-count').textContent = globalData.length;

            globalData.forEach((row, i) => {
                const formaDesc = CATALOGOS.FORMA[row.FORMA] || "Desconocido";
                const metodoDesc = CATALOGOS.METODO[row.METODO] || "Desconocido";

                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 border-b border-slate-100 transition-colors";
                tr.innerHTML = `
                    <td class="px-3 py-2 text-[10px] text-slate-400 font-mono">${i + 1}</td>
                    <td class="px-3 py-2 text-xs font-bold text-indigo-700 truncate max-w-[150px]" title="${row.RFC}">${row.RFC}</td>
                    
                    <td class="px-2 py-1"><input value="${row.CONCEPTO}" onchange="editData(${i}, 'CONCEPTO', this.value)" class="table-input text-xs w-full text-slate-700"></td>
                    <td class="px-2 py-1 bg-pink-50/30"><input value="${row.CLAVE}" onchange="editData(${i}, 'CLAVE', this.value)" class="table-input text-xs text-center font-mono text-pink-600 w-full"></td>
                    
                    <td class="px-2 py-1 bg-slate-50"><input value="${row.UNIDAD}" readonly class="table-locked"></td>
                    <td class="px-2 py-1 bg-slate-50"><input value="${row.USO}" readonly class="table-locked"></td>
                    
                    <!-- CELDA FORMA PAGO -->
                    <td class="px-2 py-1" onclick="openSelector(${i}, 'FORMA')">
                        <div class="table-select group text-xs text-slate-600 font-bold bg-white">
                            ${row.FORMA}
                            <span class="tooltip-text">${formaDesc}</span>
                        </div>
                    </td>
                    
                    <!-- CELDA METODO PAGO -->
                    <td class="px-2 py-1" onclick="openSelector(${i}, 'METODO')">
                        <div class="table-select group text-xs text-slate-600 font-bold bg-white">
                            ${row.METODO}
                            <span class="tooltip-text">${metodoDesc}</span>
                        </div>
                    </td>
                    
                    <td class="px-2 py-1"><input type="number" step="0.01" value="${row.SUBTOTAL.toFixed(2)}" onchange="editData(${i}, 'SUBTOTAL', this.value)" class="table-input text-right text-xs font-mono text-slate-600"></td>
                    <td class="px-2 py-1"><input type="number" step="0.01" value="${row.IVA.toFixed(2)}" onchange="editData(${i}, 'IVA', this.value)" class="table-input text-right text-xs font-mono text-slate-600"></td>
                    
                    <td class="px-3 py-2 text-right text-xs font-mono font-bold text-slate-700 bg-slate-50/50">
                        <span id="total-${i}">${row.TOTAL.toFixed(2)}</span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.editData = function(idx, field, val) {
            const row = globalData[idx];
            if (field === 'SUBTOTAL' || field === 'IVA') {
                row[field] = parseFloat(val) || 0;
                row.TOTAL = Math.round((row.SUBTOTAL + row.IVA) * 100) / 100;
                document.getElementById(`total-${idx}`).textContent = row.TOTAL.toFixed(2);
            } else {
                row[field] = val;
            }
        };

        // ==========================================
        // DESCARGA
        // ==========================================
        const COLUMNAS_FW = [
            'RFC_FACTURADORA', 'RFC_RECEPTOR', 'SUCURSAL_FACTURADORA', 'ES_EXPORTACION',
            'INTERNA_CLIENTE', 'USO_COMPROBANTE', 'FORMA_PAGO', 'METODO_PAGO',
            'DIVISA', 'TC', 'SAT_CLAVE_UNIDAD', 'UNIDAD', 'CANTIDAD',
            'CLAVE_SAT_CONCEPTO', 'CONCEPTO', 'IMPORTE', 'OBJETO_IMPUESTOS',
            'PORCIVA', 'IVA_TRAS', 'PORCIEPS', 'IEPS_TRAS', 'TOTAL',
            'PERIODICIDAD', 'MES', 'ANIO', 'REFERENCIAS_COMENTARIOS'
        ];

        document.getElementById('download-btn').addEventListener('click', () => {
            if (globalData.length === 0) return;
            // REMOVED: getting global-rfc-emisor value

            const exportData = globalData.map(d => ({
                RFC_FACTURADORA: d.RFC_EMISOR || "", // Removed globalRfcEmisor fallback
                RFC_RECEPTOR: d.RFC,
                SUCURSAL_FACTURADORA: "MATRIZ",
                ES_EXPORTACION: "01",
                INTERNA_CLIENTE: "INTERNA",
                USO_COMPROBANTE: d.USO,
                FORMA_PAGO: d.FORMA,
                METODO_PAGO: d.METODO,
                DIVISA: "MXN", TC: 1.0,
                SAT_CLAVE_UNIDAD: d.UNIDAD,
                UNIDAD: "UNIDAD DE SERVICIO",
                CANTIDAD: 1,
                CLAVE_SAT_CONCEPTO: d.CLAVE,
                CONCEPTO: d.CONCEPTO,
                IMPORTE: d.SUBTOTAL,
                OBJETO_IMPUESTOS: "02", PORCIVA: 0.16,
                IVA_TRAS: d.IVA, PORCIEPS: "", IEPS_TRAS: "",
                TOTAL: d.TOTAL,
                PERIODICIDAD: "", MES: "", ANIO: "", REFERENCIAS_COMENTARIOS: ""
            }));

            const ws = XLSX.utils.json_to_sheet(exportData, { header: COLUMNAS_FW });
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Hoja1");
            XLSX.writeFile(wb, "plantilla_fw.xls", { bookType: 'xls' }); 
        });

        function resetApp() { location.reload(); }
        function toggleDatabasePanel() { document.getElementById('db-panel').classList.toggle('translate-x-full'); }
        init();
    </script>
</body>
</html>
